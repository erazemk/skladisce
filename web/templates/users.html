{{define "content"}}
<h1>Uporabniki</h1>

<div class="flex-between mb-2">
    <div></div>
    <button class="btn btn-primary" onclick="document.getElementById('add-form').style.display='block'">Dodaj uporabnika</button>
</div>

<div id="add-form" class="card" style="display:none">
    <h2>Nov uporabnik</h2>
    <form method="POST" action="/users">
        <div class="grid-2">
            <div class="form-group">
                <label for="username">Uporabniško ime</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Geslo</label>
                <input type="password" id="password" name="password" required>
            </div>
        </div>
        <div class="form-group">
            <label for="role">Vloga</label>
            <select id="role" name="role" required>
                <option value="user">Uporabnik</option>
                <option value="manager">Skladiščar</option>
                <option value="admin">Administrator</option>
            </select>
        </div>
        <div class="flex gap-1">
            <button type="submit" class="btn btn-primary">Shrani</button>
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('add-form').style.display='none'">Prekliči</button>
        </div>
    </form>
</div>

<div class="card">
    <table>
        <thead>
            <tr><th>Uporabniško ime</th><th>Vloga</th><th>Ustvarjeno</th><th></th></tr>
        </thead>
        <tbody>
            {{range .Users}}
            <tr>
                <td>{{.Username}}</td>
                <td><span class="badge badge-{{.Role}}">{{roleName .Role}}</span></td>
                <td>{{.CreatedAt.Format "02.01.2006"}}</td>
                <td class="flex gap-1">
                    {{if ne .ID $.User.UserID}}
                    <button class="btn btn-secondary btn-sm" onclick="openResetModal({{.ID}}, '{{.Username}}')">Ponastavi geslo</button>
                    <button class="btn btn-danger btn-sm" hx-delete="/api/users/{{.ID}}" hx-headers='{"Authorization": "Bearer {{$.Token}}"}' hx-confirm="Ali ste prepričani, da želite izbrisati uporabnika {{.Username}}?" hx-target="closest tr" hx-swap="delete">Izbriši</button>
                    {{else}}
                    <span style="color: var(--text-muted); font-style: italic">Trenutni uporabnik</span>
                    {{end}}
                </td>
            </tr>
            {{else}}
            <tr><td colspan="4" style="color: var(--text-muted)">Ni uporabnikov.</td></tr>
            {{end}}
        </tbody>
    </table>
</div>

<!-- Password reset modal -->
<div id="reset-modal" class="modal" style="display:none">
    <div class="card" style="max-width:400px; margin:10vh auto">
        <h2>Ponastavi geslo</h2>
        <p>Novo geslo za uporabnika <strong id="reset-username"></strong>:</p>
        <form method="POST" id="reset-form">
            <div class="form-group">
                <label for="new_password">Novo geslo</label>
                <input type="password" id="new_password" name="new_password" required minlength="1">
            </div>
            <div class="flex gap-1">
                <button type="submit" class="btn btn-primary">Ponastavi</button>
                <button type="button" class="btn btn-secondary" onclick="closeResetModal()">Prekliči</button>
            </div>
        </form>
    </div>
</div>
<style>
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; }
</style>
<script>
function openResetModal(id, username) {
    document.getElementById('reset-username').textContent = username;
    document.getElementById('reset-form').action = '/users/' + id + '/password';
    document.getElementById('new_password').value = '';
    document.getElementById('reset-modal').style.display = 'block';
    document.getElementById('new_password').focus();
}
function closeResetModal() {
    document.getElementById('reset-modal').style.display = 'none';
}
</script>
{{end}}
